# TrueNAS Homeâ€‘Lab

> A reproducible, wellâ€‘documented home NAS/media stack based on TrueNAS SCALE, ZFS, and a handful of selfâ€‘hosted apps (Jellyfin, Piâ€‘hole, Tailscale, etc.).   
I used AI heavily to source parts and help with setup and permission granting.
---

## ğŸ” Project Snapshot
- **Host chassis:** Fractal Define 7 (custom)  <!-- edit if different -->
- **Mainboard/CPU:** Dell Precision T3600 platform (specs TBD)  <!-- TODO: fill exact CPU/chipset -->
- **RAM:** 64â€¯GB ECC DDR3/DDR4  <!-- confirm generation -->
- **HBA:** LSI/Broadcom 9300â€‘8i (IT mode)
- **System OS:** TrueNAS **SCALE** (version: `x.y.z`)  <!-- TODO: add current -->
- **Primary pool:** RAIDâ€‘Z2 with 6Ã—4â€¯TB (hot spare: 1Ã—4â€¯TB)  <!-- adjust if needed -->
- **Apps (major):** Jellyfin, Piâ€‘hole (alt host), Tailscale, (Future: LibreNMS, Home Assistant, FreePBX)
- **Clients:** Windows 10/11 ripper PC (SMB), macOS, Apple TV (Swiftfin)
- **Last reviewed:** YYYYâ€‘MMâ€‘DD  

> **Goal:** Stable media + fileserver with resilient ZFS, sane snapshots/replication, easy remote access, and clear runbooks for maintenance.

---

## ğŸ—‚ï¸ Repo Structure
```
truenas-homelab/
â”œâ”€ README.md                  # you are here
â”œâ”€ docs/
â”‚  â”œâ”€ architecture.md         # high-level diagram + design decisions
â”‚  â”œâ”€ zfs-layout.md           # vdevs, datasets, compression, recordsize
â”‚  â”œâ”€ shares-and-perms.md     # SMB/NFS/ACL patterns
â”‚  â”œâ”€ apps/                   # Jellyfin, Pi-hole, Tailscale configs/notes
â”‚  â”‚  â”œâ”€ jellyfin.md
â”‚  â”‚  â”œâ”€ pihole.md
â”‚  â”‚  â””â”€ tailscale.md
â”‚  â”œâ”€ backup-strategy.md      # 3â€‘2â€‘1, offsite, cloud, cold storage
â”‚  â”œâ”€ monitoring-alerting.md  # email alerts, SMART, UPS, health checks
â”‚  â”œâ”€ maintenance.md          # runbooks & schedules
â”‚  â””â”€ troubleshooting.md      # common issues + fixes
â”œâ”€ config-examples/
â”‚  â”œâ”€ smb/                    # share definitions (sanitized)
â”‚  â”œâ”€ zfs/                    # snapshot tasks, replication tasks
â”‚  â”œâ”€ ups/                    # NUT/UPS snippets
â”‚  â””â”€ tailscale/              # ACLs/snippets (sanitized)
â”œâ”€ scripts/                   # helper scripts (Bash/Pwsh)
â”‚  â”œâ”€ zfs-snapshot.sh
â”‚  â”œâ”€ zfs-prune.sh
â”‚  â””â”€ health-report.sh
â””â”€ CHANGELOG.md
```

> Use this README as the landing page; keep detailed howâ€‘tos in `docs/` and runnable examples in `scripts/`.

---

## ğŸ§± Hardware Inventory
| Component | Model / Details | Notes |
|---|---|---|
| Chassis | Fractal Define 7 | hotâ€‘swap cages? fan layout? |
| Motherboard | Dell Precision T3600 | confirm BIOS version |
| CPU | TBD | add model/cores/threads |
| RAM | 64â€¯GB ECC | validated ECC in OS/`edacutil`/`dmesg` |
| HBA | LSI/Broadcom 9300â€‘8i (IT mode) | firmware & P/N |
| Boot Device | SSD (size/model) | mirrored? |
| UPS | Model TBD | USB/Network (NUT) |

### Disk Map
| Bay/Port | Drive Model | Capacity | Serial (redacted) | Pool | Role |
|---|---|---:|---|---|---|
| sda | WD Red Plus | 4â€¯TB | XXXX | MediaPool | data |
| sdb | â€¦ | â€¦ | â€¦ | MediaPool | data |
| â€¦ | â€¦ | â€¦ | â€¦ | MediaPool | hotâ€‘spare |

---

## ğŸ§® ZFS Design
- **Pool:** `MediaPool` (RAIDâ€‘Z2)
- **Compression:** `lz4`
- **Ashift:** 12 (4â€¯K sectors)
- **Recordsize:** defaults except: `MediaPool/Media/Movies` âœ `1M` (large files)
- **Atime:** `off` for media datasets
- **ACL:** NFSv4 ACLs (Windowsâ€‘friendly)

### Dataset Layout (example)
```
MediaPool
â”œâ”€ Apps
â”‚  â””â”€ Jellyfin
â”œâ”€ Media
â”‚  â”œâ”€ Movies
â”‚  â”œâ”€ TV
â”‚  â”œâ”€ Music
â”‚  â””â”€ Photos
â””â”€ Backups
   â”œâ”€ PC
   â””â”€ Mac
```

### Snapshot Policy (baseline)
- **Hourly**: keep 24
- **Daily**: keep 14
- **Weekly**: keep 8
- **Monthly**: keep 6â€“12  

> Adjust for space; media is mostly appendâ€‘only, so daily+weekly may suffice. Place commands/tasks in `config-examples/zfs/`.

#### Example CLI (TrueNAS SCALE shell)
```bash
# adâ€‘hoc snapshot
zfs snapshot -r MediaPool@manual-$(date +%Y%m%d-%H%M)

# list snapshots & used space
zfs list -t snapshot -o name,used,creation | sort
```

> **Note:** Snapshot *used* grows only as blocks change; on media libraries (writeâ€‘once), retention can be generous with modest space impact. Track with `zfs list -t snapshot`.

---

## ğŸ“¤ Replication & Backup
- **Local replication:** `MediaPool/*` âœ `BackupPool/*` (if/when added)
- **Offsite:** (TBD) cloud bucket or rotating USB disk (cold storage)
- **Integrity:** `zpool scrub` monthly; SMART short weekly, long quarterly

Checklist:
- [ ] Define 3â€‘2â€‘1 targets in `docs/backup-strategy.md`
- [ ] Schedule scrubs in TrueNAS Tasks
- [ ] Document restore DR test (e.g., simulated file loss)

---

## ğŸ“¡ Networking & Services
### SMB Shares
| Share | Dataset | Purpose | Clients | Notes |
|---|---|---|---|---|
| `Media` | `MediaPool/Media` | Jellyfin ingest | Windows/macOS | caseâ€‘insensitive ok |
| `Rips` | `MediaPool/Media/Movies/_incoming` | from Windows ripper | Windows | write perms; mover job |

**Windows ripper PC mapping**
```powershell
# Map drive on login
New-PSDrive -Name M -PSProvider FileSystem -Root \\truenas\Media -Persist
```

### Jellyfin (Apps)
- Mount path: `/mnt/MediaPool/Media`
- Transcoding: (VAAPI/NVENC?)  <!-- TODO: fill -->
- Client notes: Apple TV (Swiftfin) â†’ enable native player if A/V sync issues

### Tailscale
- TrueNAS app defaults mostly OK; restrict exit nodes; use `--advertise-routes` only if needed
- ACL examples in `config-examples/tailscale/`

### Piâ€‘hole
- Temporary secondary instance on Ubuntu/Mac (notes in `docs/apps/pihole.md`)
- Permanent instance recommended on dedicated VM/container

---

## ğŸ”” Monitoring & Alerting
- **Email alerts:** SMTP config (redacted); test via System Settings â†’ Alert Services â†’ Send Test
- **SMART:** enable perâ€‘disk; weekly short/quarterly long; alert thresholds
- **UPS/NUT:** connect USB/network; configure shutdown on low battery; test
- **Health report:** `scripts/health-report.sh` to summarize `zpool status`, SMART, temps

---

## ğŸ› ï¸ Maintenance Runbooks
Place detailed steps in `docs/maintenance.md`. Example schedule:

| Task | Cadence | Command/Where |
|---|---|---|
| `zpool scrub MediaPool` | Monthly | Tasks â†’ Scrub |
| SMART short test | Weekly | Storage â†’ Disks â†’ S.M.A.R.T. |
| SMART long test | Quarterly | â€¦ |
| App updates | Monthly | Apps â†’ Updates |
| Config backup | Monthly/Before changes | System â†’ General â†’ Save Config |

---

## ğŸ§¯ Troubleshooting Log (samples)
- **ECC verification:** dashboard shows ECC; CLI: `dmesg | grep -i ecc` or `edac-util`  <!-- add exact output -->
- **Swiftfin A/V sync:** toggle â€œUse native playerâ€ on Apple TV
- **SMB perms:** use NFSv4 ACL editor; avoid Unix perms on Windows shares
- **Jellyfin library empty:** confirm dataset mapping + rescan metadata

Document real incidents & fixes in `docs/troubleshooting.md`.

---

## ğŸ” Security Notes
- Create nonâ€‘root admin
- Strong SMB auth; disable guest
- Tailscale ACLs: least privilege
- Regular OS/app updates

---

## ğŸ§­ Roadmap
- [ ] Add LibreNMS for network monitoring
- [ ] Migrate Piâ€‘hole to VM in homelab
- [ ] Offsite backup target + automation
- [ ] Publish sanitized config examples
- [ ] Diagram hardware & network in `docs/architecture.md`

---

## ğŸ§© How to Reproduce (Quickstart)
```text
1) Install TrueNAS SCALE on mirrored boot SSDs
2) Flash HBA to IT mode (if needed); attach drives
3) Create `MediaPool` (RAIDâ€‘Z2), datasets (above), set compression/atime
4) Configure SMB shares; apply NFSv4 ACLs
5) Install Jellyfin app; mount media dataset
6) Configure snapshots + (optional) replication
7) Set up email alerts, SMART, and UPS
8) (Optional) Tailscale for remote access
```

---

## ğŸ§¾ CHANGELOG
See `CHANGELOG.md` and date every meaningful change (hardware, pool layout, ACL policy, apps, backup).

---

## ğŸ“ Badges (optional)
Add shields.io badges to highlight versions/health:
```
![TrueNAS](https://img.shields.io/badge/TrueNAS-SCALE-informational)
![ZFS](https://img.shields.io/badge/ZFS-RAIDZ2-blue)
```

---
